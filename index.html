<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETDAH-AD</title>
<style>
  :root{
    /* TEMA CLARO (PADR√ÉO) */
    --bg:#f3f4f6;
    --card:#ffffff;
    --line:#e5e7eb;
    --text:#0f172a;
    --muted:#6b7280;
    --pri:#6d28d9;
    --ok:#10b981;
    --err:#b91c1c;
    --warn:#f59e0b;
    --surface:#f9fafb;
    --chip:#eef2ff;
    --chipHover:#e0e7ff;
    --chipSel:#e0e7ff;
    --ok-bg:#ecfdf3;
    --ok-border:#bbf7d0;
    --ok-text:#166534;
    --err-bg:#fef2f2;
    --err-border:#fecaca;
    --err-text:#7f1d1d;
    --warn-bg:#fffbeb;
    --warn-border:#fef3c7;
    --warn-text:#92400e;
  }

  /* TEMA ESCURO */
  [data-theme="dark"]{
    --bg:#0e1625;
    --card:#14213b;
    --line:#2b3f66;
    --text:#f8fafc;
    --muted:#cbd5e1;
    --pri:#6d28d9;
    --ok:#10b981;
    --err:#ef4444;
    --warn:#f59e0b;
    --surface:#0b1220;
    --chip:#0b1220;
    --chipHover:#0f1a2e;
    --chipSel:#1e293b;
    --ok-bg:#06351f;
    --ok-border:#0e6c45;
    --ok-text:#c8ffe3;
    --err-bg:#3b0d0d;
    --err-border:#7f1d1d;
    --err-text:#ffd5d5;
    --warn-bg:#3a2903;
    --warn-border:#885e09;
    --warn-text:#ffe6b0;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition:background .2s ease,color .2s ease;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    box-shadow:0 18px 40px rgba(15,23,42,.15);
  }

  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:6px;
  }
  .header-main{flex:1 1 auto}

  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .theme-btn{
    align-self:flex-start;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--text);
    font-size:.85rem;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .theme-btn:hover{background:var(--surface)}

  @media (max-width:720px){
    .header{flex-direction:column-reverse;align-items:flex-start}
  }

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:var(--muted);
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.03em;
  }

  .section{
    margin:18px 0 8px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--surface);
    font-weight:700;
  }

  /* ===== ITENS ===== */
  .item{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--surface);
    margin-bottom:12px;
  }
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{
    display:grid;
    grid-template-columns:repeat(3,minmax(220px,1fr));
    gap:10px;
  }
  @media (max-width:820px){
    .scale{grid-template-columns:1fr}
  }

  /* Bot√µes de escolha (0..5) */
  .opt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,transform .05s ease;
  }
  .opt:hover{
    background:var(--chipHover);
    border-color:var(--pri);
    transform:translateY(-1px);
  }
  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;
    height:0;
    position:absolute;
    opacity:0;
  }
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){
    background:var(--chipSel);
    border-color:var(--pri);
    box-shadow:0 0 0 1px var(--pri) inset;
  }

  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin:6px 0 12px;
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:var(--surface);
    font-size:.86rem;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted);
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:12px 0;padding:12px;border-radius:10px;font-size:.9rem}
  .okbox{
    background:var(--ok-bg);
    border:1px solid var(--ok-border);
    color:var(--ok-text);
  }
  .errbox{
    background:var(--err-bg);
    border:1px solid var(--err-border);
    color:var(--err-text);
  }
  .warnbox{
    background:var(--warn-bg);
    border:1px solid var(--warn-border);
    color:var(--warn-text);
  }

  .progress{
    height:10px;
    background:var(--surface);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden;
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#6d28d9,#10b981);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="header-main">
        <h1>ETDAH-AD</h1>
        <p class="muted">
          Considere os <b>√∫ltimos 6 meses</b>. Marque a op√ß√£o que melhor descreve a frequ√™ncia:
        </p>
      </div>
      <button id="themeToggle" class="theme-btn" type="button">üåô Modo escuro</button>
    </div>

    <div class="legend">
      <span class="pill">Nunca</span>
      <span class="pill">Muito raramente</span>
      <span class="pill">Raramente</span>
      <span class="pill">Geralmente</span>
      <span class="pill">Frequentemente</span>
      <span class="pill">Muito frequentemente</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/69</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ETDAH_AD" };
const CODE = "ADULT69";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["ETDAH_AD"]; // colunas de libera√ß√£o no Patients

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const TOKEN = qs("token");

/* ===== TEMA CLARO/ESCURO ===== */
const THEME_KEY = "integrada_theme";

function applyTheme(theme){
  const root = document.documentElement;
  root.setAttribute("data-theme", theme);
  const btn = $("#themeToggle");
  if(btn){
    btn.textContent = theme === "dark" ? "‚òÄÔ∏è Modo claro" : "üåô Modo escuro";
  }
}

function initTheme(){
  let theme = "light";
  try{
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === "dark" || saved === "light") theme = saved;
  }catch(_){}
  applyTheme(theme);

  const btn = $("#themeToggle");
  if(btn){
    btn.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); }catch(_){}
    });
  }
}

if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", initTheme);
} else {
  initTheme();
}

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ITENS (69) ===== */
const ITEMS = [
"√â atento quando conversa com algu√©m.",
"√â afobado no trabalho.",
"Necessita fazer listas de tudo o que tem para fazer para n√£o se esquecer de nada.",
"Sente-se chateado e infeliz.",
"Quando tem de seguir instru√ß√µes (receitas, montagem de m√≥veis), segue passo a passo e em sequ√™ncia, tal como lhe √© apresentado.",
"√â desorganizado financeiramente.",
"√â solit√°rio.",
"Termina tudo o que come√ßa.",
"Explode com facilidade (√© do tipo pavio curto).",
"√â detalhista e minucioso.",
"Arruma encrenca e confus√£o facilmente.",
"Mostra-se insens√≠vel √† dor e ao perigo.",
"Tem sono agitado, mexe-se na cama.",
"√â bem-aceito por todos.",
"Costuma se dar mal por falar as coisas sem pensar.",
"√â persistente e insistente diante de uma ideia.",
"Acidenta-se com facilidade (cai, trope√ßa, esbarra em m√≥veis).",
"Tende a discordar das regras e normas.",
"D√° impress√£o de que n√£o sabe o que quer.",
"Evita trabalhos longos, detalhados e complicados.",
"Tem dificuldade para se adaptar √†s mudan√ßas.",
"A qualidade do trabalho √© comprometida porque n√£o presta aten√ß√£o suficiente.",
"Inicia uma atividade com entusiasmo e dificilmente chega ao fim, √© do tipo fogo de palha.",
"Evita as atividades que exijam esfor√ßo mental prolongado (p. ex., leitura, filmes).",
"Perde a paci√™ncia com os familiares.",
"√â rebelde com as pessoas e as situa√ß√µes.",
"Persiste quando quer alguma coisa.",
"Tem tend√™ncia a sonhar acordado.",
"Faz planos cuidadosamente, considera todos os passos do come√ßo ao fim.",
"Parece sonhar acordado.",
"Faz seu trabalho r√°pido demais.",
"√â distra√≠do com tudo.",
"Dificilmente chega ao final de um projeto.",
"Seu h√°bito de trabalho √© confuso e desorganizado.",
"Necessita estar em constante movimenta√ß√£o.",
"Atrasa os pagamentos porque se esquece das datas de vencimento.",
"Mostra-se ap√°tico e indiferente diante das situa√ß√µes.",
"Tem fortes rea√ß√µes emocionais (p. ex., choro, explos√µes de raiva, bate portas, quebra objetos, etc.).",
"√â agressivo.",
"Tem problemas com a lei e/ou com a justi√ßa.",
"√â imprudente, arrisca sempre.",
"√â tolerante diante das situa√ß√µes.",
"Tem dificuldade para permanecer sentado, quando isso se faz necess√°rio.",
"√â conhecido pelos outros como desligado, parecendo viver no espa√ßo.",
"Seu jeito de ser √© motivo de discuss√£o em casa.",
"Tira conclus√µes mesmo antes de conhecer os fatos.",
"Necessita estar em situa√ß√µes mais perigosas e arriscadas.",
"Tem dificuldade em aceitar a opini√£o dos outros.",
"Faz as coisas devagar, apresenta um ritmo de trabalho lento.",
"Distrai-se enquanto trabalha e outras pessoas conversam.",
"A mente voa longe enquanto l√™.",
"Faz tudo o que d√° em sua cabe√ßa.",
"Costuma vingar-se das pessoas, n√£o engole sapo.",
"Precisa ser lembrado dos compromissos di√°rios.",
"Vive isolado, evita as atividades de grupo.",
"√â mais desorganizado do que a maioria das pessoas.",
"N√£o observa detalhes e min√∫cias.",
"Persiste at√© o fim com os seus objetivos, mesmo que sejam dif√≠ceis de alcan√ßar.",
"Sabe aguardar a vez (p. ex., fila de banco, em consult√≥rios, etc.).",
"Responde antes de ouvir a pergunta inteira.",
"√â criticado por seu jeito de ser.",
"Intromete-se em assuntos que n√£o lhe dizem respeito.",
"Costuma criticar os outros.",
"Tem mem√≥ria ruim para guardar instru√ß√µes, ordens recebidas ou para decorar o que √© preciso.",
"Planeja suas a√ß√µes, respeitando cada etapa do processo.",
"√â impulsivo; age antes de pensar.",
"Costuma se esquecer de datas, n√∫meros de telefone, compromissos importantes, a n√£o ser que os anote.",
"Necessita de novidades e de variedades em sua vida.",
"Tem dificuldade para processar as informa√ß√µes recebidas."
];

const TOTAL_ITEMS = ITEMS.length;

/* ===== ESCALA (0..5) ===== */
const CHOICES = [
  {v:0, l:'Nunca'},
  {v:1, l:'Muito raramente'},
  {v:2, l:'Raramente'},
  {v:3, l:'Geralmente'},
  {v:4, l:'Frequentemente'},
  {v:5, l:'Muito frequentemente'},
];

/* ===== SUBESCALAS ===== */
const DESAT = [6,19,20,22,23,24,28,30,32,33,34,36,37,44,49,50,51,54,56,57,64,67,69];
const IMPULS = [9,11,12,15,18,25,26,38,39,40,41,45,46,47,48,52,53,60,61,62,63,66,68];
const EMO = [4,7,21,55];
const AUTORREG_INV = [1,5,8,10,14,16,27,29,42,58,59,65]; // invertidos
const HIPER = [2,3,13,17,31,35,43];

/* invers√£o 0‚Üî5, 1‚Üî4, 2‚Üî3 */
const inv6 = v => (5 - v);

/* ===== ESTADO GLOBAL ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `ETDAH_AD_${TOKEN||'anon'}`;
let startAt = Date.now();

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";

  const sec = document.createElement('div');
  sec.className='section';
  sec.textContent='Responda a todos os 69 itens (0‚Ä¶5).';
  host.appendChild(sec);

  ITEMS.forEach((text, idx)=>{
    const q = idx+1;
    const qn = String(q).padStart(2,"0");

    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = `${q}. ${text}`;

    const scale = document.createElement('div');
    scale.className = 'scale';

    CHOICES.forEach(c=>{
      const lab = document.createElement('label');
      lab.className = 'opt';
      lab.setAttribute('title', `${c.l} (${c.v})`);
      const id = `q${qn}_${c.v}`;
      lab.innerHTML = `
        <input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}">
        <span>${c.l}</span><small></small>`;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });

  // progresso inicial
  $("#progressText").textContent = `Progresso: 0/${TOTAL_ITEMS}`;
}

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"n√£o").toLowerCase()==="sim")
      throw new Error("Token desativado. Pe√ßa um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date())
      throw new Error("Token expirado. Pe√ßa um novo link.");

    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente n√£o encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(
      k => String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    if(!isAllowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™.","err");
      return;
    }

    // J√° respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(
      k => String(patient[k]||"").trim().toLowerCase()==="sim"
    );
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espa√ßo para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){
        el.checked = true;
      }
    }
  }catch(_){}
}
function clearDraft(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
}

function countAnswered(){
  let c=0;
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn=String(i).padStart(2,'0');
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const answered = countAnswered();
  $("#progressText").textContent = `Progresso: ${answered}/${TOTAL_ITEMS}`;
  $("#bar").style.width = `${(answered/TOTAL_ITEMS)*100}%`;
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== C√ÅLCULOS / SCORING ===== */
function computeScores(answersMap){
  const sumFrom = (arr, invert=false)=>{
    let s=0;
    for(const idx of arr){
      const qn = `q${String(idx).padStart(2,"0")}`;
      let v = answersMap[qn] ?? 0;
      if(invert) v = inv6(v);
      s += v;
    }
    return s;
  };

  const desat  = sumFrom(DESAT,false);
  const impuls = sumFrom(IMPULS,false);
  const emo    = sumFrom(EMO,false);
  const autor  = sumFrom(AUTORREG_INV,true);
  const hiper  = sumFrom(HIPER,false);

  let total = 0;
  for(let i=1;i<=TOTAL_ITEMS;i++){
    total += answersMap[`q${String(i).padStart(2,"0")}`] ?? 0;
  }

  return { desat, impuls, emo, autor, hiper, total };
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

    // 1. valida√ß√£o: todas respondidas
    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // 2. Anti-duplicidade
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // 3. Coleta respostas
    const answersMap = {};
    const questionsArr = []; // [{ "pergunta": "r√≥tulo" }]

    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      const val = Number(sel.value);

      const choiceInfo = CHOICES.find(c => c.v === val) || {l:"",v:val};
      const label = choiceInfo.l;
      const questionText = ITEMS[i-1] || "";

      answersMap[`q${qn}`] = val;

      const obj = {};
      obj[questionText] = label;
      questionsArr.push(obj);
    }

    // 4. Subescalas e total
    const scores = computeScores(answersMap);
    const { desat, impuls, emo, autor, hiper, total } = scores;

    const categoria_csv = [
      `Desatencao=${desat}`,
      `Impulsividade=${impuls}`,
      `AspectosEmocionais=${emo}`,
      `Autorregulacao=${autor}`,
      `Hiperatividade=${hiper}`
    ].join(',');

    const durationSec = Math.round((Date.now()-startAt)/1000);

    // 5. Salva no Sheets
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: "",
      questions: JSON.stringify(questionsArr)
    });

    // 6. Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formul√°rio enviado. Voltando ao portal‚Ä¶","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});
</script>
</body>
</html>
