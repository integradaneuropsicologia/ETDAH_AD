<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ETDAH-AD</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}

  /* ===== ITENS ===== */
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:10px}
  @media (max-width:820px){ .scale{grid-template-columns:1fr} }

  /* Botões de escolha (0..5) */
  .opt{
    display:flex;align-items:center;gap:10px; padding:10px 12px;
    border:1px solid var(--line); border-radius:12px; background:var(--chip);
    cursor:pointer; transition:background .15s ease, border-color .15s ease, transform .05s ease;
  }
  .opt:hover{background:var(--chipHover); border-color:#4f70ff; transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none; width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel); border-color:#6d28d9; box-shadow:0 0 0 1px #6d28d9 inset}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#6d28d9,#10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ETDAH-AD</h1>
    <p class="muted">
      Considere os <b>últimos 6 meses</b>. Marque a opção que melhor descreve a frequência:
    </p>
    <div class="legend">
      <span class="pill">0 = Nunca</span>
      <span class="pill">1 = Muito raramente</span>
      <span class="pill">2 = Raramente</span>
      <span class="pill">3 = Geralmente</span>
      <span class="pill">4 = Frequentemente</span>
      <span class="pill">5 = Muito frequentemente</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/69</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ETDAH_AD" };
const CODE = "ADULT69";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["ETDAH_AD"]; // nome da(s) coluna(s) de liberação no Patients

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const TOKEN = qs("token"); // <-- estava faltando antes
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent = text; el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display = "block"; }
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d = onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d] = String(iso).split("-"); if(!y||!m||!d) return iso; return `${d}/${m}/${y}`; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp = new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:[row] }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ITENS (69) ===== */
const ITEMS = [
"É atento quando conversa com alguém.",
"É afobado no trabalho.",
"Necessita fazer listas de tudo o que tem para fazer para não se esquecer de nada.",
"Sente-se chateado e infeliz.",
"Quando tem de seguir instruções (receitas, montagem de móveis), segue passo a passo e em sequência, tal como lhe é apresentado.",
"É desorganizado financeiramente.",
"É solitário.",
"Termina tudo o que começa.",
"Explode com facilidade (é do tipo pavio curto).",
"É detalhista e minucioso.",
"Arruma encrenca e confusão facilmente.",
"Mostra-se insensível à dor e ao perigo.",
"Tem sono agitado, mexe-se na cama.",
"É bem-aceito por todos.",
"Costuma se dar mal por falar as coisas sem pensar.",
"É persistente e insistente diante de uma ideia.",
"Acidenta-se com facilidade (cai, tropeça, esbarra em móveis).",
"Tende a discordar das regras e normas.",
"Dá impressão de que não sabe o que quer.",
"Evita trabalhos longos, detalhados e complicados.",
"Tem dificuldade para se adaptar às mudanças.",
"A qualidade do trabalho é comprometida porque não presta atenção suficiente.",
"Inicia uma atividade com entusiasmo e dificilmente chega ao fim, é do tipo fogo de palha.",
"Evita as atividades que exijam esforço mental prolongado (p. ex., leitura, filmes).",
"Perde a paciência com os familiares.",
"É rebelde com as pessoas e as situações.",
"Persiste quando quer alguma coisa.",
"Tem tendência a sonhar acordado.",
"Faz planos cuidadosamente, considera todos os passos do começo ao fim.",
"Parece sonhar acordado.",
"Faz seu trabalho rápido demais.",
"É distraído com tudo.",
"Dificilmente chega ao final de um projeto.",
"Seu hábito de trabalho é confuso e desorganizado.",
"Necessita estar em constante movimentação.",
"Atrasa os pagamentos porque se esquece das datas de vencimento.",
"Mostra-se apático e indiferente diante das situações.",
"Tem fortes reações emocionais (p. ex., choro, explosões de raiva, bate portas, quebra objetos, etc.).",
"É agressivo.",
"Tem problemas com a lei e/ou com a justiça.",
"É imprudente, arrisca sempre.",
"É tolerante diante das situações.",
"Tem dificuldade para permanecer sentado, quando isso se faz necessário.",
"É conhecido pelos outros como desligado, parecendo viver no espaço.",
"Seu jeito de ser é motivo de discussão em casa.",
"Tira conclusões mesmo antes de conhecer os fatos.",
"Necessita estar em situações mais perigosas e arriscadas.",
"Tem dificuldade em aceitar a opinião dos outros.",
"Faz as coisas devagar, apresenta um ritmo de trabalho lento.",
"Distrai-se enquanto trabalha e outras pessoas conversam.",
"A mente voa longe enquanto lê.",
"Faz tudo o que dá em sua cabeça.",
"Costuma vingar-se das pessoas, não engole sapo.",
"Precisa ser lembrado dos compromissos diários.",
"Vive isolado, evita as atividades de grupo.",
"É mais desorganizado do que a maioria das pessoas.",
"Não observa detalhes e minúcias.",
"Persiste até o fim com os seus objetivos, mesmo que sejam difíceis de alcançar.",
"Sabe aguardar a vez (p. ex., fila de banco, em consultórios, etc.).",
"Responde antes de ouvir a pergunta inteira.",
"É criticado por seu jeito de ser.",
"Intromete-se em assuntos que não lhe dizem respeito.",
"Costuma criticar os outros.",
"Tem memória ruim para guardar instruções, ordens recebidas ou para decorar o que é preciso.",
"Planeja suas ações, respeitando cada etapa do processo.",
"É impulsivo; age antes de pensar.",
"Costuma se esquecer de datas, números de telefone, compromissos importantes, a não ser que os anote.",
"Necessita de novidades e de variedades em sua vida.",
"Tem dificuldade para processar as informações recebidas."
];

/* ===== GRUPOS ===== */
const DESAT = [6,19,20,22,23,24,28,30,32,33,34,36,37,44,49,50,51,54,56,57,64,67,69];
const IMPULS = [9,11,12,15,18,25,26,38,39,40,41,45,46,47,48,52,53,60,61,62,63,66,68];
const EMO = [4,7,21,55];
const AUTORREG_INV = [1,5,8,10,14,16,27,29,42,58,59,65]; // invertidos 0..5 -> 5..0
const HIPER = [2,3,13,17,31,35,43];

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  const s = document.createElement('div');
  s.className='section';
  s.textContent='Responda a todos os 69 itens (0…5).';
  host.appendChild(s);

  ITEMS.forEach((text, idx)=>{
    const q = idx+1, qn = String(q).padStart(2,"0");
    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = `${q}. ${text}`;

    const scale = document.createElement('div');
    scale.className = 'scale';

    const CHOICES = [
      {v:0, l:'Nunca'},
      {v:1, l:'Muito raramente'},
      {v:2, l:'Raramente'},
      {v:3, l:'Geralmente'},
      {v:4, l:'Frequentemente'},
      {v:5, l:'Muito frequentemente'},
    ];

    CHOICES.forEach(c=>{
      const lab = document.createElement('label'); lab.className = 'opt'; lab.setAttribute('title', `${c.l} (${c.v})`);
      const id = `q${qn}_${c.v}`;
      lab.innerHTML = `<input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}"><span>${c.l}</span><small></small>`;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `ETDAH_AD_${TOKEN||'anon'}`;

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200); return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn("Sem espaço para salvar rascunho"); }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){ /* ignore */ }
}
function clearDraft(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

function countAnswered(){ let c=0; for(let i=1;i<=ITEMS.length;i++){ const qn=String(i).padStart(2,'0'); if(document.querySelector(`input[name="q${qn}"]:checked`)) c++; } return c; }
function updateProgress(){ const answered = countAnswered(); const total = ITEMS.length; $("#progressText").textContent = `Progresso: ${answered}/${total}`; $("#bar").style.width = `${(answered/total)*100}%`; }

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{ if(e.target && e.target.matches('input[type="radio"][name^="q"]')){ saveDraft(); updateProgress(); } });
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox('#msg','Rascunho salvo neste dispositivo.','ok'); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox('#msg','Rascunho apagado.','warn'); });

/* ===== CÁLCULOS ===== */
const inv6 = v => 5 - v; // inversão 0↔5, 1↔4, 2↔3
function sumSet(indices, transform){
  let s = 0;
  for(const i of indices){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    const val = sel ? Number(sel.value) : 0;
    s += transform ? transform(val) : val;
  }
  return s;
}
function sumRange(from,to){
  let s=0;
  for(let i=from;i<=to;i++){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending = true; hideBox("#msg");
  const btn = $("#btnSubmit"); const originalText = btn.textContent; btn.disabled = true; btn.textContent = "Enviando…";
  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Validação: todas respondidas
    for(let i=1;i<=ITEMS.length;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // Subescalas
    const desat  = sumSet(DESAT);
    const impuls = sumSet(IMPULS);
    const emo    = sumSet(EMO);
    const autor  = sumSet(AUTORREG_INV, inv6);
    const hiper  = sumSet(HIPER);

    // Total geral (1..69) — se você quiser usar
    const total  = sumRange(1,69);

    const categoria_csv = [
      `Desatencao=${desat}`,
      `Impulsividade=${impuls}`,
      `AspectosEmocionais=${emo}`,
      `Autorregulacao=${autor}`,
      `Hiperatividade=${hiper}`
    ].join(',');

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: ""
    });

    // Marca como feito no Patients
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) doneUpdates[k] = "sim"; });
    if(Object.keys(doneUpdates).length===0) doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false; btn.disabled = false; btn.textContent = originalText;
  }
});
</script>
</body>
</html>

